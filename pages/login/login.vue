<template>
	<view class="padding-login">
		<view class="title-y">
			欢迎登录/注册数农科技！
		</view>
		<view class="border-bottom">
			<view class="cu-form-group">
				<input @input="onInput" type="number" placeholder="请输入手机号码" name="input"></input>
			</view>
		</view>
		<view class="border-bottom">
			<view class="cu-form-group">
				<input placeholder="请输入验证码" name="input" @input="captchaInput"></input>
				<button class='cu-btn line-green shadow' :disabled="disabled" @click="codeClick">{{btnTitle}}{{txt}}</button>
			</view>
		</view>
		<button class="cu-btn block bg-green margin-tb-sm lg positon-btn" style="margin-top:100rpx" open-type="getUserInfo"
		 lang="zh_CN" @getuserinfo="onGotUserInfo" withCredentials="true">
			登录</button>
		<view class="auto-bottom">
			注册即为同意<text class="agreement">《数农科技用户使用协议》</text>
		</view>

	</view>
</template>
<script>
	export default {
		data() {
			return {
				title: 'Hello',
				obj: {
					phone: '',
					yzm: ''
				},
				headPortrait: '',
				name: '',
				disabled: false,
				btnTitle: "获取验证码",
				txt: '',
				user:{
					nickName:'',
					avatarUrl:''
				}
			}
		},
		onLoad() {},
		onShow() {
			// uni.hideHomeButton()
		},
		onShareAppMessage(res) {
			return {
				title: '农事云',
				path: '/pages/index/index'
			}
		},
		onBackPress(e) {
			// return true 表示禁止默认返回
			return false
		},
		methods: {
			onInput(e) {
				this.obj.phone = e.detail.value
			},
			onPwdInput(e) {
				this.obj.yzm = e.detail.value
			},
			// 手动授权方法
			onGotUserInfo(e) {
				let _this=this
				wx.login({
					success(res) {
						if (res.code) {
							//发起网络请求
							var code = res.code
							// 获取微信用户信息
							wx.getUserInfo({
								success: function(res) {
									var userInfo = res.userInfo
									_this.user.nickName = userInfo.nickName //昵称
									_this.user.avatarUrl = userInfo.avatarUrl //头像
									_this.userLogin()
								},
								fail: res => {
									console.info('失败')
									// 获取失败的去引导用户授权 
								}
							})
						} else {

						}
					}
				})
			},
			codeClick() {
				//点击发送验证码		     
				let _this = this
				if (!this.obj.phone) {
					uni.showToast({
						title: '请输入手机号',
						icon: 'none'
					})
					return
				}
				this.disabled = true
				this.$api.captcha({
					phone: this.obj.phone
				}).then(res => {
					if (res.data.state == 200) {
						this.btnTitle = 60
						this.txt = 'S秒后获取'
						let timer = setInterval(function() {
							if (_this.btnTitle == 1) {
								clearInterval(timer)
								_this.btnTitle = '获取验证码'
								_this.txt = ''
								_this.disabled = false
							} else {
								_this.btnTitle = _this.btnTitle - 1
							}
						}, 1000)
					} else {
						this.disabled = false
					}
				})
			},
			userLogin() {
				let that = this;
				uni.switchTab({
					url: '../personal/personal'
				});
				return
				this.$api.login(this.obj).then(res => {
					if (res.data.code == 200) {
						let obj = {
							token: res.data.data.token,					
							nickName: this.user.nickName,
							avatarUrl: this.user.avatarUrl,
							phone: this.obj.phone,
						}

						uni.setStorage({
							key: 'userInfo',
							data: obj,
							success() {
								uni.showToast({
									title: '登录成功',
									icon: 'success',
									success() {
										console.log(obj.landOrgan.length)
										uni.switchTab({
											url: '../plantManage/plantManage'
										});

									}
								})
							}
						})
					}
				})
			}
		}
	}
</script>

<style lang="less">
	page {
		background: #fff;
	}

	.text-margin {
		margin-left: 5px;
		font-size: 15px;
	}

	.border-bottom {
		border-bottom: 1px solid #eee;
		padding: 5px 0;

		.uni-input-placeholder {
			font-size: 16px;
		}

		.iconfont {
			position: relative;
			top: 2px;
		}
	}

	.padding-login {
		padding: 0 60rpx;
	}

	.color-green {
		color: #00AE66;
	}

	.logo-box {
		width: 200rpx;
		height: 200rpx;
		margin: 0 auto;
	}

	.title-y {
		text-align: left;
		margin: 80rpx 0;
		font-size: 21px;
		font-weight: bold;
	}

	.auto-bottom {
		padding-top: 30vh;
		text-align: center;

		.agreement {
			color: #0FD4FF;
		}
	}
</style>
